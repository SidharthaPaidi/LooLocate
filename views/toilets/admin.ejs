<% layout('layouts/boilerplate') %>
<link rel="stylesheet" href="/css/index.css">
<style>
  .status-section {
    margin-bottom: 3rem;
  }
  .status-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #e0e0e0;
  }
  .status-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.875rem;
    font-weight: 600;
    text-transform: uppercase;
  }
  .status-badge.pending {
    background-color: #fff3cd;
    color: #856404;
  }
  .status-badge.approved {
    background-color: #d4edda;
    color: #155724;
  }
  .status-badge.rejected {
    background-color: #f8d7da;
    color: #721c24;
  }
  .admin-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
  }
  .btn-approve, .btn-reject {
    flex: 1;
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 600;
    text-decoration: none;
    display: inline-block;
    text-align: center;
    transition: all 0.2s;
  }
  .btn-approve {
    background-color: #28a745;
    color: white;
  }
  .btn-approve:hover {
    background-color: #218838;
  }
  .btn-reject {
    background-color: #dc3545;
    color: white;
  }
  .btn-reject:hover {
    background-color: #c82333;
  }
  .btn-change-status {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 600;
    text-decoration: none;
    display: inline-block;
    text-align: center;
    transition: all 0.2s;
    background-color: #6c757d;
    color: white;
    margin-top: 0.5rem;
  }
  .btn-change-status:hover {
    background-color: #5a6268;
  }
  .author-info {
    font-size: 0.875rem;
    color: #666;
    margin-top: 0.5rem;
  }
</style>

<h1 class="text-3xl font-bold mb-6">Admin Panel - Toilet Management</h1>

<% 
  // Ensure arrays are defined
  const pendingList = (typeof pending !== 'undefined' && Array.isArray(pending)) ? pending : [];
  const approvedList = (typeof approved !== 'undefined' && Array.isArray(approved)) ? approved : [];
  const rejectedList = (typeof rejected !== 'undefined' && Array.isArray(rejected)) ? rejected : [];
  const totalToilets = pendingList.length + approvedList.length + rejectedList.length;
%>

<% if (totalToilets === 0) { %>
  <div class="no-toilets-found" style="text-align: center; padding: 2rem;">
    <div class="no-toilets-icon">ðŸš½</div>
    <h3 class="no-toilets-title">No Toilets Found</h3>
    <p class="no-toilets-message">There are no toilets in the database yet.</p>
    <a href="/toilets/new" class="btn-add-first">
      <i class="bi bi-plus-circle"></i>
      Add First Toilet
    </a>
  </div>
<% } %>

<!-- Pending Toilets Section -->
<div class="status-section">
  <div class="status-header">
    <h2>Pending Review</h2>
    <span class="status-badge pending"><%= pendingList.length %> Pending</span>
  </div>
  <% if (pendingList.length > 0) { %>
    <div class="toilet-grid">
      <% pendingList.forEach(toilet => { %>
        <div class="toilet-card">
          <img
            src="<%= toilet.images && toilet.images.length ? toilet.images[0].url : 'https://placehold.co/600x400' %>"
            class="toilet-image" alt="<%= toilet.title %>">
          <div class="toilet-card-content">
            <h3 class="toilet-title"><%= toilet.title %></h3>
            <p class="toilet-location">
              <i class="bi bi-geo-alt"></i>
              <%= toilet.location %>
            </p>
            <% if (toilet.author) { %>
              <p class="author-info">
                <i class="bi bi-person"></i>
                Added by: <%= toilet.author.username || toilet.author.email || 'Unknown' %>
              </p>
            <% } %>
            <div class="toilet-features">
              <span class="feature-badge <%= toilet.isPaid ? 'paid' : 'free' %>">
                <%= toilet.isPaid ? `â‚¹${toilet.price || 0}` : 'Free' %>
              </span>
              <span class="feature-badge"><%= toilet.genderAccess %></span>
              <% if (toilet.isAccessible) { %>
                <span class="feature-badge">â™¿ Accessible</span>
              <% } %>
            </div>
            <% if (typeof toilet.cleanlinessRating === 'number' && toilet.cleanlinessRating > 0) { %>
              <div class="toilet-rating">
                <%= 'â­'.repeat(Math.max(0, Math.min(5, toilet.cleanlinessRating))) %> (<%= toilet.cleanlinessRating %>/5)
              </div>
            <% } %>
            <div class="admin-actions">
              <form method="POST" action="/toilets/<%= toilet._id %>/approve" style="flex: 1;">
                <button type="submit" class="btn-approve">âœ“ Approve</button>
              </form>
              <form method="POST" action="/toilets/<%= toilet._id %>/reject" style="flex: 1;">
                <button type="submit" class="btn-reject">âœ— Reject</button>
              </form>
            </div>
            <a href="/toilets/<%= toilet._id %>" class="view-button" style="margin-top: 0.5rem; display: block; text-align: center;">
              View Details
            </a>
          </div>
        </div>
      <% }) %>
    </div>
  <% } else { %>
    <p style="color: #666; padding: 1rem;">No pending toilets to review.</p>
  <% } %>
</div>

<!-- Approved Toilets Section -->
<div class="status-section">
  <div class="status-header">
    <h2>Approved Toilets</h2>
    <span class="status-badge approved"><%= approvedList.length %> Approved</span>
  </div>
  <% if (approvedList.length > 0) { %>
    <div class="toilet-grid">
      <% approvedList.forEach(toilet => { %>
        <div class="toilet-card">
          <img
            src="<%= toilet.images && toilet.images.length ? toilet.images[0].url : 'https://placehold.co/600x400' %>"
            class="toilet-image" alt="<%= toilet.title %>">
          <div class="toilet-card-content">
            <h3 class="toilet-title"><%= toilet.title %></h3>
            <p class="toilet-location">
              <i class="bi bi-geo-alt"></i>
              <%= toilet.location %>
            </p>
            <% if (toilet.author) { %>
              <p class="author-info">
                <i class="bi bi-person"></i>
                Added by: <%= toilet.author.username || toilet.author.email || 'Unknown' %>
              </p>
            <% } %>
            <div class="toilet-features">
              <span class="feature-badge <%= toilet.isPaid ? 'paid' : 'free' %>">
                <%= toilet.isPaid ? `â‚¹${toilet.price || 0}` : 'Free' %>
              </span>
              <span class="feature-badge"><%= toilet.genderAccess %></span>
              <% if (toilet.isAccessible) { %>
                <span class="feature-badge">â™¿ Accessible</span>
              <% } %>
            </div>
            <% if (typeof toilet.cleanlinessRating === 'number' && toilet.cleanlinessRating > 0) { %>
              <div class="toilet-rating">
                <%= 'â­'.repeat(Math.max(0, Math.min(5, toilet.cleanlinessRating))) %> (<%= toilet.cleanlinessRating %>/5)
              </div>
            <% } %>
            <form method="POST" action="/toilets/<%= toilet._id %>/reject" style="margin-top: 0.5rem;">
              <button type="submit" class="btn-change-status">Change to Rejected</button>
            </form>
            <a href="/toilets/<%= toilet._id %>" class="view-button" style="margin-top: 0.5rem; display: block; text-align: center;">
              View Details
            </a>
          </div>
        </div>
      <% }) %>
    </div>
  <% } else { %>
    <p style="color: #666; padding: 1rem;">No approved toilets yet.</p>
  <% } %>
</div>

<!-- Rejected Toilets Section -->
<div class="status-section">
  <div class="status-header">
    <h2>Rejected Toilets</h2>
    <span class="status-badge rejected"><%= rejectedList.length %> Rejected</span>
  </div>
  <% if (rejectedList.length > 0) { %>
    <div class="toilet-grid">
      <% rejectedList.forEach(toilet => { %>
        <div class="toilet-card">
          <img
            src="<%= toilet.images && toilet.images.length ? toilet.images[0].url : 'https://placehold.co/600x400' %>"
            class="toilet-image" alt="<%= toilet.title %>">
          <div class="toilet-card-content">
            <h3 class="toilet-title"><%= toilet.title %></h3>
            <p class="toilet-location">
              <i class="bi bi-geo-alt"></i>
              <%= toilet.location %>
            </p>
            <% if (toilet.author) { %>
              <p class="author-info">
                <i class="bi bi-person"></i>
                Added by: <%= toilet.author.username || toilet.author.email || 'Unknown' %>
              </p>
            <% } %>
            <div class="toilet-features">
              <span class="feature-badge <%= toilet.isPaid ? 'paid' : 'free' %>">
                <%= toilet.isPaid ? `â‚¹${toilet.price || 0}` : 'Free' %>
              </span>
              <span class="feature-badge"><%= toilet.genderAccess %></span>
              <% if (toilet.isAccessible) { %>
                <span class="feature-badge">â™¿ Accessible</span>
              <% } %>
            </div>
            <% if (typeof toilet.cleanlinessRating === 'number' && toilet.cleanlinessRating > 0) { %>
              <div class="toilet-rating">
                <%= 'â­'.repeat(Math.max(0, Math.min(5, toilet.cleanlinessRating))) %> (<%= toilet.cleanlinessRating %>/5)
              </div>
            <% } %>
            <form method="POST" action="/toilets/<%= toilet._id %>/approve" style="margin-top: 0.5rem;">
              <button type="submit" class="btn-change-status">Approve Now</button>
            </form>
            <a href="/toilets/<%= toilet._id %>" class="view-button" style="margin-top: 0.5rem; display: block; text-align: center;">
              View Details
            </a>
          </div>
        </div>
      <% }) %>
    </div>
  <% } else { %>
    <p style="color: #666; padding: 1rem;">No rejected toilets.</p>
  <% } %>
</div>

<div style="margin-top: 2rem; text-align: center;">
  <a href="/toilets" class="btn-clear-filters">
    <i class="bi bi-arrow-left"></i>
    Back to Toilets Dashboard
  </a>
</div>
